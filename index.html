<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game Hub (GitLab Library)</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <main class="page">
      <header class="header">
        <h1>Game Hub</h1>
        <p class="sub">
          This site pulls games from
          <span class="mono">zigz0g/3kh0-assets</span> and serves them through
          glcdn.githack CDN.
        </p>
        <div class="toolbar">
          <label for="cleverness-select" class="toolbar-label">Cleverness</label>
          <select id="cleverness-select" class="select">
            <option value="off">Off</option>
            <option value="on">On</option>
          </select>
          <button type="button" id="surprise-btn" class="button secondary">
            Surprise me
          </button>
        </div>
      </header>

      <section class="card">
        <div class="card-header">
          <div>
            <h2 id="active-game-title">Loading games...</h2>
            <p class="hint">Pick a game from the library below.</p>
          </div>
          <a
            class="link"
            id="active-game-link"
            href="#"
            target="_blank"
            rel="noopener noreferrer"
          >
            Open game in new tab
          </a>
        </div>

        <div class="frame-wrapper">
          <iframe id="game-frame" title="Embedded game player" loading="lazy" allowfullscreen></iframe>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <div>
            <h2>Games library</h2>
            <p class="hint" id="library-status">Reading game folders from GitLab...</p>
          </div>
        </div>
        <div class="library-grid" id="games-grid"></div>
      </section>
    </main>

    <script>
      const REPO_PATH = "zigz0g/3kh0-assets";
      const BRANCH = "main";
      const CDN_BASE = `https://glcdn.githack.com/${REPO_PATH}/raw/${BRANCH}`;
      const API_BASE = `https://gitlab.com/api/v4/projects/${encodeURIComponent(REPO_PATH)}/repository/tree`;

      const frameEl = document.getElementById("game-frame");
      const titleEl = document.getElementById("active-game-title");
      const linkEl = document.getElementById("active-game-link");
      const statusEl = document.getElementById("library-status");
      const gridEl = document.getElementById("games-grid");
      const clevernessEl = document.getElementById("cleverness-select");
      const surpriseBtnEl = document.getElementById("surprise-btn");
      let allFolders = [];
      let currentFolders = [];

      function gameUrl(folder) {
        return `${CDN_BASE}/${encodeURIComponent(folder)}/index.html`;
      }

      function toLabel(folder) {
        return folder
          .replace(/[-_]+/g, " ")
          .replace(/\b\w/g, (letter) => letter.toUpperCase());
      }

      function cleverScore(folder) {
        const lower = folder.toLowerCase();
        let score = 0;
        if (/\d/.test(lower)) score += 1;
        if (lower.includes("run")) score += 4;
        if (lower.includes("mario")) score += 4;
        if (lower.includes("minecraft")) score += 4;
        if (lower.includes("cookie")) score += 3;
        if (lower.includes("2048")) score += 3;
        if (lower.includes("basket")) score += 2;
        if (lower.includes("tank")) score += 2;
        if (lower.includes("doom")) score += 2;
        if (lower.length <= 10) score += 1;
        return score;
      }

      function sortedFolders(folders) {
        if (clevernessEl.value !== "on") {
          return [...folders];
        }
        return [...folders].sort((a, b) => {
          const diff = cleverScore(b) - cleverScore(a);
          if (diff !== 0) return diff;
          return a.localeCompare(b);
        });
      }

      function loadGame(folder) {
        const label = toLabel(folder);
        const url = gameUrl(folder);
        titleEl.textContent = `${label} (from ${REPO_PATH})`;
        linkEl.href = url;
        frameEl.src = url;
      }

      async function fetchGameFolders() {
        const folders = [];
        for (let page = 1; page <= 30; page += 1) {
          const response = await fetch(
            `${API_BASE}?ref=${encodeURIComponent(BRANCH)}&per_page=100&page=${page}`
          );
          if (!response.ok) {
            throw new Error(`GitLab API error: ${response.status}`);
          }
          const pageData = await response.json();
          if (!Array.isArray(pageData) || pageData.length === 0) {
            break;
          }
          const trees = pageData
            .filter((entry) => entry.type === "tree")
            .map((entry) => entry.path)
            .filter((path) => !path.startsWith("."));
          folders.push(...trees);
          if (pageData.length < 100) {
            break;
          }
        }
        return [...new Set(folders)].sort((a, b) => a.localeCompare(b));
      }

      function renderGameButtons(folders) {
        const visibleFolders = sortedFolders(folders);
        currentFolders = visibleFolders;
        gridEl.innerHTML = "";
        visibleFolders.forEach((folder, index) => {
          const card = document.createElement("article");
          card.className = "game-card";

          const title = document.createElement("h3");
          title.textContent = toLabel(folder);

          const folderTag = document.createElement("p");
          folderTag.className = "folder-tag";
          folderTag.textContent = folder;

          const actions = document.createElement("div");
          actions.className = "game-actions";

          const playBtn = document.createElement("button");
          playBtn.type = "button";
          playBtn.className = "button";
          playBtn.textContent = "Play in page";
          playBtn.addEventListener("click", () => loadGame(folder));

          const openLink = document.createElement("a");
          openLink.className = "button secondary";
          openLink.href = gameUrl(folder);
          openLink.target = "_blank";
          openLink.rel = "noopener noreferrer";
          openLink.textContent = "Open tab";

          actions.append(playBtn, openLink);
          card.append(title, folderTag, actions);
          gridEl.appendChild(card);

          if (index === 0) {
            loadGame(folder);
          }
        });
      }

      function surprisePick() {
        if (!currentFolders.length) return;
        const pick = currentFolders[Math.floor(Math.random() * currentFolders.length)];
        loadGame(pick);
      }

      async function init() {
        try {
          const folders = await fetchGameFolders();
          if (folders.length === 0) {
            statusEl.textContent = "No top-level game folders with index.html were found.";
            titleEl.textContent = "No games found";
            return;
          }
          statusEl.textContent = `Loaded ${folders.length} games from ${REPO_PATH}.`;
          allFolders = folders;
          renderGameButtons(folders);
        } catch (error) {
          console.error(error);
          statusEl.textContent = "Could not read GitLab API. Showing a fallback game.";
          allFolders = ["2048"];
          renderGameButtons(allFolders);
        }
      }

      clevernessEl.addEventListener("change", () => {
        renderGameButtons(allFolders.length ? allFolders : ["2048"]);
      });
      surpriseBtnEl.addEventListener("click", surprisePick);

      init();
    </script>
  </body>
  </html>
